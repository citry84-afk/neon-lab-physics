<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no">
    <title>Neon Lab - Physics Puzzle</title>
    
    <!-- Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-633RQLC6T0"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-633RQLC6T0');
    </script>
    
    <!-- AdSense -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4129506161314540" crossorigin="anonymous"></script>
    
    <!-- PWA Icons -->
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Ccircle cx='16' cy='16' r='16' fill='%23FF0080'/%3E%3Cpath d='M8 8h16v8H8z' fill='%23FFFF00' stroke='%23FFFFFF'/%3E%3Ccircle cx='12' cy='24' r='3' fill='%2339FF14'/%3E%3C/svg%3E">
    <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 180 180'%3E%3Crect width='180' height='180' rx='40' fill='%23FF0080'/%3E%3Cpath d='M40 40h40v40H40z' fill='%23FFFF00' stroke='%23FFFFFF' stroke-width='3'/%3E%3Ccircle cx='60' cy='120' r='12' fill='%2339FF14'/%3E%3Ctext x='90' y='110' font-family='monospace' font-size='24' fill='%2300FFFF'%3ELAB%3C/text%3E%3C/svg%3E">
    <meta name="theme-color" content="#FF0080">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: monospace;
            background: linear-gradient(135deg, #000 0%, #111 100%);
            color: #00FFFF;
            overflow-x: hidden;
            user-select: none;
            touch-action: manipulation;
        }
        .header {
            height: 50px;
            background: rgba(0,0,0,0.9);
            border-bottom: 2px solid #00FFFF;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 15px;
        }
        .title { font-size: 1.5rem; font-weight: bold; color: #39FF14; }
        .level-info { font-size: 0.9rem; }
        
        .instructions {
            background: rgba(0,0,0,0.8);
            color: #00FFFF;
            padding: 8px;
            text-align: center;
            font-size: 11px;
        }
        
        .game-area {
            height: calc(100vh - 150px);
            display: flex;
            justify-content: center;
            align-items: center;
            background: 
                linear-gradient(90deg, transparent 49%, rgba(0, 255, 255, 0.05) 50%, transparent 51%),
                linear-gradient(0deg, transparent 49%, rgba(0, 255, 255, 0.05) 50%, transparent 51%);
            background-size: 20px 20px;
        }
        
        canvas {
            border: 2px solid #FF0080;
            box-shadow: 0 0 15px rgba(255, 0, 128, 0.3);
            background: rgba(0, 0, 0, 0.3);
            touch-action: none;
        }
        
        .controls {
            height: 80px;
            background: rgba(0,0,0,0.9);
            border-top: 2px solid #00FFFF;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
            padding: 8px;
        }
        
        button {
            background: #FF0080;
            color: white;
            border: none;
            padding: 12px 18px;
            border-radius: 4px;
            cursor: pointer;
            font-family: monospace;
            font-size: 11px;
            font-weight: bold;
        }
        button.secondary { background: #00FFFF; color: #000; }
        button.tertiary { background: #666; }
        button:active { transform: scale(0.95); }
        
        /* Epic Victory Effects */
        .victory-explosion {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1500;
            pointer-events: none;
        }
        
        .confetti {
            position: absolute;
            width: 10px;
            height: 10px;
            background: linear-gradient(45deg, #FF0080, #00FFFF, #39FF14, #FFFF00);
            animation: confetti-fall 2s ease-in-out forwards;
        }
        
        @keyframes confetti-fall {
            0% {
                transform: translateY(-100vh) rotate(0deg);
                opacity: 1;
            }
            100% {
                transform: translateY(100vh) rotate(720deg);
                opacity: 0;
            }
        }
        
        .sparks {
            position: absolute;
            width: 4px;
            height: 4px;
            background: #FFFF00;
            border-radius: 50%;
            box-shadow: 0 0 10px #FFFF00;
            animation: spark-burst 1.5s ease-out forwards;
        }
        
        @keyframes spark-burst {
            0% {
                transform: scale(1) translate(0, 0);
                opacity: 1;
            }
            100% {
                transform: scale(0) translate(var(--spark-x, 0), var(--spark-y, 0));
                opacity: 0;
            }
        }
        
        .victory-message {
            position: fixed;
            top: 30%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, #FF0080, #00FFFF);
            color: #FFFFFF;
            padding: 20px 30px;
            border-radius: 15px;
            border: 3px solid #FFFF00;
            font-size: 1.5rem;
            font-weight: bold;
            text-align: center;
            z-index: 2000;
            animation: victory-pop 0.8s ease-out;
            box-shadow: 0 0 30px rgba(255, 255, 0, 0.8);
        }
        
        @keyframes victory-pop {
            0% {
                transform: translate(-50%, -50%) scale(0) rotate(180deg);
                opacity: 0;
            }
            50% {
                transform: translate(-50%, -50%) scale(1.2) rotate(0deg);
                opacity: 1;
            }
            100% {
                transform: translate(-50%, -50%) scale(1) rotate(0deg);
                opacity: 1;
            }
        }
        
        .screen-flash {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, rgba(255, 255, 0, 0.3) 0%, transparent 70%);
            z-index: 1000;
            animation: flash 0.5s ease-out;
            pointer-events: none;
        }
        
        @keyframes flash {
            0% { opacity: 0; }
            50% { opacity: 1; }
            100% { opacity: 0; }
        }        @media (max-width: 768px) {
            .game-area { height: calc(100vh - 160px) !important; }
            .controls { position: fixed; bottom: 0; left: 0; right: 0; z-index: 1000; }
            canvas {
                width: 95vw !important;
                height: auto !important;
                max-width: 350px;
                max-height: 60vh;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="title">ÔøΩÔøΩ NEON LAB</div>
        <div class="level-info" id="levelDisplay">LEVEL 1</div>
        <div class="lives-display" id="livesDisplay">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</div>
    </div>
    
    <div class="instructions">
        üéØ ARRASTRA objetos, DOBLE TAP para rotar, presiona TEST
    </div>
    
    <div class="game-area">
        <canvas id="gameCanvas" width="350" height="500"></canvas>
    </div>
    
    <div class="controls">
        <button onclick="resetLevel()">üîÑ RESET</button>
        <button onclick="launchParticle()">üöÄ GO!</button>
        <button class="secondary" onclick="nextLevel()">‚û°Ô∏è NEXT</button>
        <button class="tertiary" onclick="showHelp()">‚ùì HELP</button>
    </div>

    <script>
        console.log("üß™ NEON LAB - FIXED VERSION");
        
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        
        let gameState = {
            currentLevel: 1,
            objects: [],
            particle: null,
            launcher: null,
            chamber: null,
            draggedObject: null,
            dragOffset: { x: 0, y: 0 },
            lives: 3,
            maxLives: 3
        };
        
        let isDragging = false;
        let lastTapTime = 0;
        let tapTarget = null;
        let lastTime = 0;
        
        // Responsive canvas
        function resizeCanvas() {
            if (window.innerWidth < 768) {
                const maxWidth = Math.min(350, window.innerWidth - 20);
                const maxHeight = Math.min(500, window.innerHeight * 0.6);
                canvas.width = maxWidth;
                canvas.height = maxHeight;
            } else {
                canvas.width = 350;
                canvas.height = 500;
            }
        }
        
        class GameObject {
            constructor(type, x, y, width, height, color) {
                this.type = type;
                this.x = x;
                this.y = y;
                this.width = width;
                this.height = height;
                this.color = color;
                this.rotation = 0;
                this.draggable = type !== 'launcher' && type !== 'chamber';
            }
            
            render(ctx) {
                ctx.save();
                ctx.translate(this.x + this.width/2, this.y + this.height/2);
                ctx.rotate(this.rotation);
                
                ctx.fillStyle = this.color;
                ctx.strokeStyle = this.color;
                ctx.lineWidth = 2;
                ctx.shadowColor = this.color;
                ctx.shadowBlur = 8;
                
                if (this.type === 'ramp') {
                    // Triangle
                    ctx.beginPath();
                    ctx.moveTo(-this.width/2, this.height/2);
                    ctx.lineTo(this.width/2, this.height/2);
                    ctx.lineTo(this.width/2, -this.height/2);
                    ctx.closePath();
                    ctx.fill();
                    ctx.stroke();
                } else if (this.type === 'bouncy-pad') {
                    // Circle
                    ctx.beginPath();
                    ctx.arc(0, 0, this.width/2, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.stroke();
                } else {
                    // Rectangle
                    ctx.fillRect(-this.width/2, -this.height/2, this.width, this.height);
                    ctx.strokeRect(-this.width/2, -this.height/2, this.width, this.height);
                }
                
                ctx.restore();
            }
            
            contains(x, y) {
                return x >= this.x && x <= this.x + this.width && 
                       y >= this.y && y <= this.y + this.height;
            }
        }
        
        class Particle {
            constructor(x, y) {
                this.x = x;
                this.y = y;
                this.vx = 120;
                this.vy = -80;
                this.radius = 5;
                this.active = true;
                this.trail = [];
                this.bounces = 0;
            }
            
            update(deltaTime) {
                if (!this.active) return;
                
                // Gravity
                this.vy += 350 * deltaTime;
                
                // Update position
                this.x += this.vx * deltaTime;
                this.y += this.vy * deltaTime;
                
                // Check collisions
                for (let obj of gameState.objects) {
                    if (this.collidesWith(obj)) {
                        this.handleCollision(obj);
                        break;
                    }
                }
                
                // Boundary collisions
                if (this.x <= this.radius || this.x >= canvas.width - this.radius) {
                    this.vx = -this.vx * 0.8;
                    this.x = Math.max(this.radius, Math.min(canvas.width - this.radius, this.x));
                }
                if (this.y <= this.radius) {
                    this.vy = Math.abs(this.vy) * 0.8;
                    this.y = this.radius;
                }
                
                // Update trail
                this.trail.push({ x: this.x, y: this.y });
                if (this.trail.length > 6) this.trail.shift();
                
                // Deactivate if falls off screen
                if (this.y > canvas.height + 100) {
                    this.active = false;
                    loseLife(); // ¬°PERDER VIDA!
                }
            }
            
            collidesWith(obj) {
                // Circle vs Rectangle collision
                const closestX = Math.max(obj.x, Math.min(this.x, obj.x + obj.width));
                const closestY = Math.max(obj.y, Math.min(this.y, obj.y + obj.height));
                
                const dx = this.x - closestX;
                const dy = this.y - closestY;
                
                return (dx * dx + dy * dy) < (this.radius * this.radius);
            }
            
            handleCollision(obj) {
                // Calculate collision normal
                const centerX = obj.x + obj.width / 2;
                const centerY = obj.y + obj.height / 2;
                
                let normalX = this.x - centerX;
                let normalY = this.y - centerY;
                const length = Math.sqrt(normalX * normalX + normalY * normalY);
                
                if (length > 0) {
                    normalX /= length;
                    normalY /= length;
                }
                
                // Push particle out
                this.x = centerX + normalX * (obj.width/2 + this.radius + 1);
                this.y = centerY + normalY * (obj.height/2 + this.radius + 1);
                
                // Bounce
                const elasticity = obj.type === 'bouncy-pad' ? 1.3 : 0.75;
                const dot = this.vx * normalX + this.vy * normalY;
                
                this.vx -= 2 * dot * normalX * elasticity;
                this.vy -= 2 * dot * normalY * elasticity;
                
                // Ramp behavior
                if (obj.type === 'ramp') {
                    const speed = Math.sqrt(this.vx * this.vx + this.vy * this.vy);
                    const angle = obj.rotation - Math.PI/4;
                    this.vx = Math.cos(angle) * speed * 0.9;
                    this.vy = Math.sin(angle) * speed * 0.9;
                }
                
                this.bounces++;
            }
            
            render(ctx) {
                if (!this.active) return;
                
                // Trail
                this.trail.forEach((point, index) => {
                    ctx.save();
                    ctx.globalAlpha = (index + 1) / this.trail.length * 0.6;
                    ctx.fillStyle = '#FFFF00';
                    ctx.beginPath();
                    ctx.arc(point.x, point.y, this.radius * ((index + 1) / this.trail.length), 0, Math.PI * 2);
                    ctx.fill();
                    ctx.restore();
                });
                
                // Main particle
                ctx.save();
                ctx.fillStyle = '#FFFF00';
                ctx.shadowColor = '#FFFF00';
                ctx.shadowBlur = 12;
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2);
                ctx.fill();
                ctx.restore();
            }
        }
        
        const levels = [
            {
                name: "TUTORIAL",
                objects: [
                    { type: 'ramp', x: 130, y: 250, width: 70, height: 35, color: '#FF0080' }
                ],
                launcher: { x: 50, y: 100 },
                chamber: { x: 250, y: 420 }
            },
            {
                name: "BOUNCY",
                objects: [
                    { type: 'bouncy-pad', x: 100, y: 200, width: 40, height: 40, color: '#39FF14' },
                    { type: 'block', x: 200, y: 300, width: 60, height: 20, color: '#00FFFF' }
                ],
                launcher: { x: 30, y: 50 },
                chamber: { x: 270, y: 450 }
            },
            {
                name: "DOUBLE RAMP",
                objects: [
                    { type: 'ramp', x: 80, y: 200, width: 60, height: 30, color: '#FF0080' },
                    { type: 'ramp', x: 180, y: 300, width: 60, height: 30, color: '#FF0080' }
                ],
                launcher: { x: 40, y: 80 },
                chamber: { x: 280, y: 420 }
            },
            {
                name: "OBSTACLE",
                objects: [
                    { type: 'block', x: 120, y: 180, width: 80, height: 25, color: '#00FFFF' },
                    { type: 'ramp', x: 90, y: 280, width: 70, height: 35, color: '#FF0080' },
                    { type: 'block', x: 200, y: 350, width: 60, height: 20, color: '#00FFFF' }
                ],
                launcher: { x: 30, y: 60 },
                chamber: { x: 290, y: 440 }
            },
            {
                name: "BOUNCY MAZE",
                objects: [
                    { type: 'bouncy-pad', x: 80, y: 150, width: 35, height: 35, color: '#39FF14' },
                    { type: 'block', x: 150, y: 200, width: 70, height: 20, color: '#00FFFF' },
                    { type: 'bouncy-pad', x: 200, y: 300, width: 35, height: 35, color: '#39FF14' },
                    { type: 'ramp', x: 120, y: 380, width: 60, height: 30, color: '#FF0080' }
                ],
                launcher: { x: 40, y: 80 },
                chamber: { x: 270, y: 450 }
            },
            {
                name: "PRECISION",
                objects: [
                    { type: 'block', x: 90, y: 160, width: 15, height: 80, color: '#00FFFF' },
                    { type: 'block', x: 180, y: 200, width: 15, height: 120, color: '#00FFFF' },
                    { type: 'ramp', x: 230, y: 350, width: 50, height: 25, color: '#FF0080' }
                ],
                launcher: { x: 50, y: 90 },
                chamber: { x: 300, y: 420 }
            },
            {
                name: "MULTI BOUNCE",
                objects: [
                    { type: 'bouncy-pad', x: 70, y: 180, width: 30, height: 30, color: '#39FF14' },
                    { type: 'bouncy-pad', x: 140, y: 250, width: 30, height: 30, color: '#39FF14' },
                    { type: 'bouncy-pad', x: 210, y: 180, width: 30, height: 30, color: '#39FF14' },
                    { type: 'block', x: 170, y: 350, width: 50, height: 20, color: '#00FFFF' }
                ],
                launcher: { x: 30, y: 60 },
                chamber: { x: 280, y: 440 }
            },
            {
                name: "STAIRWAY",
                objects: [
                    { type: 'block', x: 70, y: 200, width: 40, height: 20, color: '#00FFFF' },
                    { type: 'block', x: 120, y: 250, width: 40, height: 20, color: '#00FFFF' },
                    { type: 'block', x: 170, y: 300, width: 40, height: 20, color: '#00FFFF' },
                    { type: 'ramp', x: 220, y: 350, width: 50, height: 25, color: '#FF0080' }
                ],
                launcher: { x: 40, y: 100 },
                chamber: { x: 290, y: 430 }
            },
            {
                name: "FUNNEL",
                objects: [
                    { type: 'ramp', x: 60, y: 180, width: 50, height: 25, color: '#FF0080' },
                    { type: 'ramp', x: 220, y: 180, width: 50, height: 25, color: '#FF0080' },
                    { type: 'block', x: 120, y: 280, width: 80, height: 15, color: '#00FFFF' },
                    { type: 'bouncy-pad', x: 150, y: 350, width: 30, height: 30, color: '#39FF14' }
                ],
                launcher: { x: 160, y: 60 },
                chamber: { x: 160, y: 450 }
            },
            {
                name: "CHAOS",
                objects: [
                    { type: 'bouncy-pad', x: 80, y: 150, width: 25, height: 25, color: '#39FF14' },
                    { type: 'ramp', x: 130, y: 200, width: 40, height: 20, color: '#FF0080' },
                    { type: 'block', x: 200, y: 160, width: 30, height: 15, color: '#00FFFF' },
                    { type: 'bouncy-pad', x: 90, y: 300, width: 25, height: 25, color: '#39FF14' },
                    { type: 'ramp', x: 180, y: 350, width: 40, height: 20, color: '#FF0080' },
                    { type: 'block', x: 240, y: 280, width: 25, height: 40, color: '#00FFFF' }
                ],
                launcher: { x: 40, y: 80 },
                chamber: { x: 290, y: 440 }            }
        ];
        
        function loadLevel(levelNumber) {
            const level = levels[levelNumber - 1];
            if (!level) return;
            
            gameState.objects = [];
            gameState.particle = null;
            
            // Scale for canvas size
            const scaleX = canvas.width / 350;
            const scaleY = canvas.height / 500;
            
            level.objects.forEach(objData => {
                gameState.objects.push(new GameObject(
                    objData.type,
                    objData.x * scaleX,
                    objData.y * scaleY,
                    objData.width * scaleX,
                    objData.height * scaleY,
                    objData.color
                ));
            });
            
            gameState.launcher = new GameObject(
                'launcher',
                level.launcher.x * scaleX,
                level.launcher.y * scaleY,
                20 * scaleX,
                20 * scaleY,
                '#FFFF00'
            );
            
            gameState.chamber = new GameObject(
                'chamber',
                level.chamber.x * scaleX,
                level.chamber.y * scaleY,
                30 * scaleX,
                30 * scaleY,
                '#39FF14'
            );
            
            document.getElementById('levelDisplay').textContent = `LEVEL ${levelNumber}: ${level.name}`;
        }
        
        function launchParticle() {
            if (gameState.particle && gameState.particle.active) return;
            
            gameState.particle = new Particle(
                gameState.launcher.x + gameState.launcher.width/2,
                gameState.launcher.y + gameState.launcher.height/2
            );
            
            // Timeout de 8 segundos - si no llega a la meta, perder vida
            setTimeout(() => {
                if (gameState.particle && gameState.particle.active) {
                    gameState.particle.active = false;
                    loseLife(); // ¬°PERDER VIDA POR TIMEOUT!
                }
            }, 8000);
        }
        
        function resetLevel() { loadLevel(gameState.currentLevel); }
        function loseLife() {
            gameState.lives--;
            updateLivesDisplay();
            
            // Life lost sound
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.type = 'sawtooth';
                oscillator.frequency.setValueAtTime(200, audioContext.currentTime);
                oscillator.frequency.exponentialRampToValueAtTime(100, audioContext.currentTime + 0.5);
                
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + 0.5);
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.start();
                oscillator.stop(audioContext.currentTime + 0.5);
            } catch (e) {}
            
            if (gameState.lives <= 0) {
                setTimeout(() => {
                    showGameOver();
                }, 1000);
            } else {
                setTimeout(() => {
                    alert(`üíî ¬°Experimento fallido! Te quedan ${gameState.lives} intentos.`);
                }, 500);
            }
        }
        
        function updateLivesDisplay() {
            const heartsDisplay = '‚ù§Ô∏è'.repeat(gameState.lives) + 'üñ§'.repeat(gameState.maxLives - gameState.lives);
            document.getElementById('livesDisplay').textContent = heartsDisplay;
        }
        
        function showGameOver() {
            // Game Over modal
            const modal = document.createElement('div');
            modal.className = 'victory-message';
            modal.style.background = 'linear-gradient(135deg, #FF0080, #8B0000)';
            modal.innerHTML = `
                üß™ ¬°EXPERIMENTO FALLIDO! üíÄ<br>
                <div style="font-size: 1rem; margin: 15px 0; color: #00FFFF;">
                    Nivel alcanzado: ${gameState.currentLevel}<br>
                    Has agotado todas tus vidas
                </div>
                <div style="margin: 20px 0;">
                    <button onclick="shareTwitterGameOver()" style="background: #1DA1F2; color: white; border: none; padding: 8px 15px; margin: 5px; border-radius: 5px; cursor: pointer;">üê¶ Twitter</button>
                    <button onclick="shareWhatsAppGameOver()" style="background: #25D366; color: white; border: none; padding: 8px 15px; margin: 5px; border-radius: 5px; cursor: pointer;">üì± WhatsApp</button>
                </div>
                <div>
                    <button onclick="watchAdToContinue()" style="background: #FF6600; color: white; border: none; padding: 12px 20px; margin: 5px; border-radius: 5px; cursor: pointer; font-weight: bold;">üì∫ VER ANUNCIO</button>
                    <button onclick="restartGame()" style="background: #00FFFF; color: black; border: none; padding: 12px 20px; margin: 5px; border-radius: 5px; cursor: pointer; font-weight: bold;">üîÑ REINICIAR</button>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Game over sound
            setTimeout(() => {
                try {
                    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();
                    
                    oscillator.type = 'sawtooth';
                    oscillator.frequency.setValueAtTime(150, audioContext.currentTime);
                    oscillator.frequency.exponentialRampToValueAtTime(50, audioContext.currentTime + 1);
                    
                    gainNode.gain.setValueAtTime(0.4, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + 1);
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);
                    
                    oscillator.start();
                    oscillator.stop(audioContext.currentTime + 1);
                } catch (e) {}
            }, 200);
        }        function showEpicVictory() {
            const levelName = levels[gameState.currentLevel - 1]?.name || "EXPERIMENTO";
            
            // Screen flash
            const flash = document.createElement('div');
            flash.className = 'screen-flash';
            document.body.appendChild(flash);
            setTimeout(() => flash.remove(), 500);
            
            // Victory message
            const message = document.createElement('div');
            message.className = 'victory-message';
            message.innerHTML = `üß™ ¬°${levelName} COMPLETADO! üéâ<br><span style="font-size: 1rem; color: #39FF14;">¬°Experimento exitoso!</span>`;
            document.body.appendChild(message);
            
            // Confetti explosion
            createConfetti();
            
            // Sparks burst
            createSparks();
            
            // Victory sound
            setTimeout(() => {
                const oscillator = createSimpleOscillator();
                if (oscillator) {
                    oscillator.frequency.setValueAtTime(523, oscillator.context.currentTime); // C5
                    oscillator.frequency.exponentialRampToValueAtTime(1047, oscillator.context.currentTime + 0.5); // C6
                    oscillator.start();
                    oscillator.stop(oscillator.context.currentTime + 0.5);
                }
            }, 100);
            
            // Auto advance to next level
            setTimeout(() => {
                message.remove();
                if (gameState.currentLevel < levels.length) {
                    gameState.currentLevel++;
                    loadLevel(gameState.currentLevel);
                } else {
                    // All levels completed!
                    showGameComplete();
                }
            }, 2500);
        }
        
        function createConfetti() {
            const colors = ['#FF0080', '#00FFFF', '#39FF14', '#FFFF00', '#FF6600'];
            
            for (let i = 0; i < 30; i++) {
                setTimeout(() => {
                    const confetti = document.createElement('div');
                    confetti.className = 'confetti';
                    confetti.style.background = colors[Math.floor(Math.random() * colors.length)];
                    confetti.style.left = Math.random() * 100 + '%';
                    confetti.style.animationDelay = Math.random() * 0.5 + 's';
                    confetti.style.animationDuration = (1.5 + Math.random()) + 's';
                    document.body.appendChild(confetti);
                    
                    setTimeout(() => confetti.remove(), 3000);
                }, i * 50);
            }
        }
        
        function createSparks() {
            for (let i = 0; i < 15; i++) {
                setTimeout(() => {
                    const spark = document.createElement('div');
                    spark.className = 'sparks';
                    spark.style.left = '50%';
                    spark.style.top = '50%';
                    
                    const angle = (Math.PI * 2 * i) / 15;
                    const distance = 100 + Math.random() * 100;
                    const x = Math.cos(angle) * distance;
                    const y = Math.sin(angle) * distance;
                    
                    spark.style.setProperty('--spark-x', x + 'px');
                    spark.style.setProperty('--spark-y', y + 'px');
                    
                    document.body.appendChild(spark);
                    
                    setTimeout(() => spark.remove(), 1500);
                }, i * 30);
            }
        }
        
        function createSimpleOscillator() {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.type = 'sine';
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                return oscillator;
            } catch (e) {
                return null;
            }
        }
        
        function shareTwitterGameOver() {
            const message = `üß™ ¬°He llegado al nivel ${gameState.currentLevel} en Neon Lab! ¬øPuedes llegar m√°s lejos en este puzzle de f√≠sica? üéÆ‚ö°`;
            const url = window.location.href;
            window.open(`https://twitter.com/intent/tweet?text=${encodeURIComponent(message)}&url=${encodeURIComponent(url)}`, '_blank');
        }
        
        function shareWhatsAppGameOver() {
            const message = `üß™ ¬°He llegado al nivel ${gameState.currentLevel} en Neon Lab! ¬øPuedes llegar m√°s lejos? Juega aqu√≠: ${window.location.href}`;
            window.open(`https://wa.me/?text=${encodeURIComponent(message)}`, '_blank');
        }
        
        function watchAdToContinue() {
            // Simular anuncio rewarded
            alert('¬°Anuncio visto! Te damos 2 vidas extra.');
            gameState.lives = Math.min(gameState.maxLives, gameState.lives + 2);
            updateLivesDisplay();
            
            // Remove game over modal
            const modal = document.querySelector('.victory-message');
            if (modal) modal.remove();
        }
        
        function restartGame() {
            gameState.currentLevel = 1;
            gameState.lives = gameState.maxLives;
            updateLivesDisplay();
            loadLevel(1);
            updateLivesDisplay();            
            // Remove game over modal
            const modal = document.querySelector('.victory-message');
            if (modal) modal.remove();
        }        function showGameComplete() {
            const message = document.createElement('div');
            message.className = 'victory-message';
            message.innerHTML = `üèÜ ¬°TODOS LOS EXPERIMENTOS COMPLETADOS! üèÜ<br><span style="font-size: 1rem; color: #39FF14;">¬°Eres un cient√≠fico genial!</span>`;
            message.style.fontSize = '1.2rem';
            document.body.appendChild(message);
            
            createConfetti();
            createConfetti(); // Double confetti!
            
            setTimeout(() => {
                message.remove();
                // Reset to level 1
                gameState.currentLevel = 1;
                loadLevel(1);
            updateLivesDisplay();            }, 4000);
        }        function nextLevel() {
            if (gameState.currentLevel < levels.length) {
                gameState.currentLevel++;
                loadLevel(gameState.currentLevel);
            }
        }
        function showHelp() {
            alert(`üß™ NEON LAB HELP:
            
‚Ä¢ DRAG objects to move
‚Ä¢ DOUBLE TAP to rotate  
‚Ä¢ TEST to launch particle
‚Ä¢ Guide to green target

Objects:
üìê Ramps redirect particle
üü¶ Blocks are obstacles
üü¢ Bouncy pads boost`);
        }
        
        // Touch/Mouse handling
        function getPos(event) {
            const rect = canvas.getBoundingClientRect();
            const x = (event.clientX || event.touches[0].clientX) - rect.left;
            const y = (event.clientY || event.touches[0].clientY) - rect.top;
            return {
                x: x * (canvas.width / rect.width),
                y: y * (canvas.height / rect.height)
            };
        }
        
        function handleStart(event) {
            event.preventDefault();
            const pos = getPos(event);
            const now = Date.now();
            
            for (let obj of gameState.objects) {
                if (obj.draggable && obj.contains(pos.x, pos.y)) {
                    if (tapTarget === obj && now - lastTapTime < 300) {
                        obj.rotation += Math.PI / 4;
                        return;
                    }
                    
                    gameState.draggedObject = obj;
                    gameState.dragOffset = { x: pos.x - obj.x, y: pos.y - obj.y };
                    isDragging = true;
                    tapTarget = obj;
                    lastTapTime = now;
                    break;
                }
            }
        }
        
        function handleMove(event) {
            if (!isDragging) return;
            event.preventDefault();
            
            const pos = getPos(event);
            gameState.draggedObject.x = pos.x - gameState.dragOffset.x;
            gameState.draggedObject.y = pos.y - gameState.dragOffset.y;
            
            // Keep in bounds
            gameState.draggedObject.x = Math.max(0, Math.min(canvas.width - gameState.draggedObject.width, gameState.draggedObject.x));
            gameState.draggedObject.y = Math.max(0, Math.min(canvas.height - gameState.draggedObject.height, gameState.draggedObject.y));
        }
        
        function handleEnd(event) {
            event.preventDefault();
            isDragging = false;
            gameState.draggedObject = null;
        }
        
        canvas.addEventListener('mousedown', handleStart);
        canvas.addEventListener('mousemove', handleMove);
        canvas.addEventListener('mouseup', handleEnd);
        canvas.addEventListener('touchstart', handleStart);
        canvas.addEventListener('touchmove', handleMove);
        canvas.addEventListener('touchend', handleEnd);
        
        function gameLoop(time) {
            const deltaTime = Math.min((time - lastTime) / 1000, 0.016);
            lastTime = time;
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Update particle
            if (gameState.particle) {
                gameState.particle.update(deltaTime);
                
                // Win check
                if (gameState.particle.active) {
                    const dx = gameState.particle.x - (gameState.chamber.x + gameState.chamber.width/2);
                    const dy = gameState.particle.y - (gameState.chamber.y + gameState.chamber.height/2);
                    if (Math.sqrt(dx*dx + dy*dy) < 20) {
                        gameState.particle.active = false;
                        setTimeout(() => {
                            showEpicVictory();
                        }, 300);                    }
                }
            }
            
            // Render
            gameState.launcher.render(ctx);
            gameState.chamber.render(ctx);
            gameState.objects.forEach(obj => obj.render(ctx));
            if (gameState.particle) gameState.particle.render(ctx);
            
            // Tutorial arrow
            if (gameState.currentLevel === 1 && !gameState.particle) {
                ctx.save();
                ctx.strokeStyle = "#FFFF00";
                ctx.setLineDash([5, 5]);
                ctx.beginPath();
                ctx.moveTo(gameState.launcher.x + 15, gameState.launcher.y + 15);
                ctx.lineTo(gameState.chamber.x + 15, gameState.chamber.y);
                ctx.stroke();
                ctx.restore();
            }
            
            requestAnimationFrame(gameLoop);
        }
        
        window.addEventListener('load', () => {
            // Simple background music
            let musicEnabled = false;
            
            function initSimpleMusic() {
                if (musicEnabled) return;
                musicEnabled = true;
                
                const playBgNote = () => {
                    if (!musicEnabled) return;
                    
                    try {
                        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                        const oscillator = audioContext.createOscillator();
                        const gainNode = audioContext.createGain();
                        
                        const melody = [261, 294, 329, 349, 392, 329, 261]; // C4-D4-E4-F4-G4-E4-C4
                        const noteIndex = Math.floor(Date.now() / 800) % melody.length;
                        
                        oscillator.type = 'square';
                        oscillator.frequency.setValueAtTime(melody[noteIndex], audioContext.currentTime);
                        
                        gainNode.gain.setValueAtTime(0.05, audioContext.currentTime);
                        gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + 0.3);
                        
                        oscillator.connect(gainNode);
                        gainNode.connect(audioContext.destination);
                        
                        oscillator.start();
                        oscillator.stop(audioContext.currentTime + 0.3);
                    } catch (e) {}
                    
                    setTimeout(playBgNote, 800);
                };
                
                setTimeout(playBgNote, 1000);
            }
            
            // Start music on first user interaction
            document.addEventListener('click', initSimpleMusic, { once: true });
            document.addEventListener('touchstart', initSimpleMusic, { once: true });            resizeCanvas();
            loadLevel(1);
            updateLivesDisplay();            requestAnimationFrame(gameLoop);
            
            window.addEventListener('resize', () => {
                resizeCanvas();
                loadLevel(gameState.currentLevel);
            });
        });
    </script>
    
</body>
</html>
