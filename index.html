<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no">
    <title>Neon Lab Physics WOW - Ultra Realistic Physics Engine</title>
    
    <!-- Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-633RQLC6T0"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-633RQLC6T0');
        
        window.trackDonationClick = function(amount = 'custom') {
            gtag('event', 'donation_click', {
                source: 'neon_lab_physics_wow',
                amount: amount,
                value: parseFloat(amount) || 1
            });
        };
    </script>
    
    <!-- MONETAG VERIFICATION -->
    <meta name="monetag" content="429424ce8d7544787550ae4e27dc0dbd">
    
    <!-- AdSense -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4837743291717475"
         crossorigin="anonymous"></script>
    <!-- Consent Mode v2 + Banner -->
    <script defer src="/consent.js"></script>
    <!-- Leaderboard System -->
    <script src="/leaderboard-global.js"></script>
    
    <!-- PWA Icons -->
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Ccircle cx='16' cy='16' r='16' fill='%23FF0080'/%3E%3Cpath d='M8 8h16v8H8z' fill='%23FFFF00' stroke='%23FFFFFF'/%3E%3Ccircle cx='12' cy='24' r='3' fill='%2339FF14'/%3E%3C/svg%3E">
    <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 180 180'%3E%3Crect width='180' height='180' rx='40' fill='%23FF0080'/%3E%3Cpath d='M40 40h40v40H40z' fill='%23FFFF00' stroke='%23FFFFFF' stroke-width='3'/%3E%3Ccircle cx='60' cy='120' r='12' fill='%2339FF14'/%3E%3Ctext x='90' y='110' font-family='monospace' font-size='24' fill='%2300FFFF'%3ELAB WOW%3C/text%3E%3C/svg%3E">
    <meta name="theme-color" content="#FF0080">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&display=swap');
        
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
        }
        
        body {
            font-family: 'Orbitron', monospace;
            background: 
                radial-gradient(circle at 20% 80%, rgba(120, 119, 198, 0.3) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(255, 119, 198, 0.3) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(120, 219, 255, 0.2) 0%, transparent 50%),
                linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 25%, #16213e 50%, #0e3460 75%, #0a0a0a 100%);
            color: #00FFFF;
            overflow-x: hidden;
            user-select: none;
            touch-action: manipulation;
            min-height: 100vh;
        }

        .particles-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 0;
        }

        .particle-bg {
            position: absolute;
            width: 2px;
            height: 2px;
            background: #00FFFF;
            border-radius: 50%;
            animation: float 8s linear infinite;
            opacity: 0.6;
        }

        @keyframes float {
            from { 
                transform: translateY(100vh) translateX(0px);
                opacity: 0;
            }
            10% { opacity: 0.6; }
            90% { opacity: 0.6; }
            to { 
                transform: translateY(-100px) translateX(100px);
                opacity: 0;
            }
        }

        .header {
            height: 60px;
            background: linear-gradient(135deg, rgba(0,0,0,0.9), rgba(20,20,40,0.9));
            border-bottom: 3px solid #00FFFF;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
            position: relative;
            z-index: 10;
            box-shadow: 0 0 20px rgba(0,255,255,0.3);
        }
        
        .title { 
            font-size: 1.8rem; 
            font-weight: 900; 
            color: #39FF14;
            text-shadow: 0 0 10px #39FF14;
            animation: titleGlow 2s ease-in-out infinite alternate;
        }

        @keyframes titleGlow {
            from { text-shadow: 0 0 10px #39FF14, 0 0 20px #39FF14; }
            to { text-shadow: 0 0 20px #39FF14, 0 0 30px #39FF14, 0 0 40px #39FF14; }
        }
        
        .level-info { 
            font-size: 1rem; 
            color: #00FFFF;
            text-shadow: 0 0 5px #00FFFF;
        }
        
        .lives-display { 
            font-size: 1.2rem;
            text-shadow: 0 0 5px #FF0080;
        }
        
        .instructions {
            background: linear-gradient(135deg, rgba(0,0,0,0.9), rgba(20,20,40,0.9));
            color: #00FFFF;
            padding: 12px;
            text-align: center;
            font-size: 12px;
            border-bottom: 2px solid #FF0080;
            position: relative;
            z-index: 10;
        }
        
        .game-area {
            height: calc(100vh - 180px);
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding-top: 20px;
            background: 
                linear-gradient(90deg, transparent 49%, rgba(0, 255, 255, 0.05) 50%, transparent 51%),
                linear-gradient(0deg, transparent 49%, rgba(0, 255, 255, 0.05) 50%, transparent 51%);
            background-size: 20px 20px;
            position: relative;
            overflow: hidden;
        }

        .game-area::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(circle at 30% 20%, rgba(255, 0, 128, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 70% 80%, rgba(0, 255, 255, 0.1) 0%, transparent 50%);
            pointer-events: none;
        }
        
        canvas {
            border: 3px solid #FF0080;
            box-shadow: 
                0 0 20px rgba(255, 0, 128, 0.5),
                inset 0 0 20px rgba(0, 255, 255, 0.2);
            background: linear-gradient(135deg, rgba(0,0,0,0.8), rgba(20,20,40,0.8));
            touch-action: none;
            position: relative;
            z-index: 5;
        }
        
        .controls {
            height: 80px;
            background: linear-gradient(135deg, rgba(0,0,0,0.9), rgba(20,20,40,0.9));
            border-top: 3px solid #00FFFF;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
            padding: 8px;
            position: relative;
            z-index: 10;
            box-shadow: 0 0 20px rgba(0,255,255,0.3);
        }
        
        button {
            background: linear-gradient(45deg, #FF0080, #00FFFF);
            border: 2px solid #FFFFFF;
            color: #000;
            padding: 12px 20px;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            font-family: 'Orbitron', monospace;
            font-size: 12px;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
            box-shadow: 0 4px 15px rgba(255, 0, 128, 0.3);
        }
        
        button:hover {
            background: linear-gradient(45deg, #00FFFF, #FF0080);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 255, 255, 0.5);
        }
        
        button:active {
            transform: translateY(0);
        }
        
        .secondary {
            background: linear-gradient(45deg, #39FF14, #FFFF00);
            color: #000;
        }
        
        .tertiary {
            background: linear-gradient(45deg, #8A2BE2, #FF00FF);
            color: #FFF;
        }

        .donation-section {
            margin-top: 10px;
        }

        .donation-section h3 {
            color: #FFFF00; 
            margin-bottom: 10px; 
            font-size: 12px;
            text-align: center;
        }

        .donation-section div {
            display: flex; 
            gap: 8px; 
            justify-content: center; 
            flex-wrap: wrap;
        }

        .donation-section a {
            padding: 8px 12px; 
            background: linear-gradient(45deg, #4CAF50, #8BC34A); 
            color: white; 
            font-weight: bold;
            border-radius: 6px; 
            text-decoration: none; 
            font-size: 11px;
            transition: all 0.3s ease;
        }

        .donation-section a:nth-child(2) {
            background: linear-gradient(45deg, #FF9800, #FFC107);
        }

        .donation-section a:nth-child(3) {
            background: linear-gradient(45deg, #E91E63, #F06292);
        }

        .donation-section a:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(255, 255, 255, 0.3);
        }

        .flash-effect {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, rgba(255, 255, 0, 0.4) 0%, transparent 70%);
            z-index: 1000;
            animation: flash 0.5s ease-out;
            pointer-events: none;
        }
        
        @keyframes flash {
            0% { opacity: 0; }
            50% { opacity: 1; }
            100% { opacity: 0; }
        }

        .impact-effect {
            position: absolute;
            width: 20px;
            height: 20px;
            background: radial-gradient(circle, #FFFF00, transparent);
            border-radius: 50%;
            pointer-events: none;
            z-index: 100;
            animation: impact 0.3s ease-out;
        }
        
        @keyframes impact {
            0% {
                transform: scale(0);
                opacity: 1;
            }
            100% {
                transform: scale(3);
                opacity: 0;
            }
        }
        
        .trail-particle {
            position: absolute;
            width: 4px;
            height: 4px;
            background: #00FFFF;
            border-radius: 50%;
            pointer-events: none;
            z-index: 50;
            animation: trailFade 0.5s ease-out forwards;
        }

        @keyframes trailFade {
            0% { 
                opacity: 1;
                transform: scale(1);
            }
            100% {
                opacity: 0;
                transform: scale(0.5);
            }
        }
        
        @media (max-width: 768px) {
            .game-area { 
                height: calc(100vh - 130px) !important; 
                padding-top: 3px;
            }
            .controls { 
            position: fixed;
                bottom: 0; 
            left: 0;
                right: 0; 
            z-index: 1000;
                height: 50px;
                gap: 3px;
                padding: 3px;
            }
            canvas {
                width: 90vw !important;
                height: auto !important;
                max-width: 320px;
                max-height: 50vh;
            }
            .title { font-size: 1rem; }
            button { 
                padding: 4px 8px; 
                font-size: 8px; 
            font-weight: bold;
                border-width: 1px;
            }
            .donation-section {
                margin-top: 2px;
            }
            .donation-section h3 {
                font-size: 8px;
                margin-bottom: 2px;
            }
            .donation-section a {
                padding: 3px 6px;
                font-size: 7px;
            }
            .instructions {
                font-size: 9px;
                padding: 6px;
            }
        }
    </style>
</head>
<body>
    <!-- Background Particles -->
    <div class="particles-bg" id="particlesBg"></div>

    <!-- Ads -->
    <div id="top-banner" style="position:fixed;top:0;left:0;width:100%;height:50px;background:rgba(0,0,0,0.9);z-index:9998;display:none;align-items:center;justify-content:center;border-bottom:2px solid #00FFFF;">
        <ins class="adsbygoogle" style="display:block;width:320px;height:50px;" data-ad-client="ca-pub-4837743291717475" data-ad-slot="6673201053"></ins>
    </div>
    <div id="bottom-banner" style="position:fixed;bottom:0;left:0;width:100%;height:50px;background:rgba(0,0,0,0.9);z-index:9998;display:none;align-items:center;justify-content:center;border-top:2px solid #00FFFF;">
        <ins class="adsbygoogle" style="display:block;width:320px;height:50px;" data-ad-client="ca-pub-4837743291717475" data-ad-slot="6673201053"></ins>
    </div>
    
    <div id="side-banner" style="position:fixed; right:10px; top:50%; transform:translateY(-50%); width:120px; height:600px; background:rgba(0,0,0,0.8); border:1px solid #00FFFF; border-radius:8px; display:none; z-index:1000;">
        <ins class="adsbygoogle" 
             style="display:block;width:120px;height:600px;" 
             data-ad-client="ca-pub-4837743291717475" 
             data-ad-slot="6673201053"></ins>
    </div>

    <div class="header">
        <div class="title">🧪 NEON LAB PHYSICS WOW</div>
        <div class="level-info" id="levelDisplay">LEVEL 1</div>
        <div class="lives-display" id="livesDisplay">❤️❤️❤️</div>
    </div>
    
    <div id="menu-banner" style="margin: 10px 0; padding: 10px; background: rgba(0,0,0,0.8); border: 1px solid #00FFFF; border-radius: 8px; text-align: center;">
        <ins class="adsbygoogle" 
             style="display:block;width:320px;height:50px;" 
             data-ad-client="ca-pub-4837743291717475" 
             data-ad-slot="6673201053"></ins>
    </div>
    
    <div class="instructions">
        🎯 ARRASTRA objetos para crear el camino, DOBLE TAP para rotar, LAUNCH para soltar la partícula
    </div>
    
    <div class="game-area">
        <canvas id="gameCanvas" width="400" height="600"></canvas>
    </div>
    
    <div class="controls">
        <button onclick="resetLevel()">🔄 RESET</button>
        <button onclick="launchParticle()">⬇️ DROP</button>
        <button class="secondary" onclick="nextLevel()">➡️ NEXT</button>
        <button class="tertiary" onclick="showHelp()">❓ HELP</button>
        <button onclick="showLeaderboard('neon-lab-physics-wow')" style="background: linear-gradient(45deg, #FFD700, #FFA500); color: #000;">🏆 RANKING</button>
        <div class="donation-section">
            <h3>💖 ¡Apoya el desarrollo!</h3>
            <div>
                <a href="https://paypal.me/lipastudios/0.50" target="_blank" onclick="trackDonationClick('0.50')">☕ 0,50€</a>
                <a href="https://paypal.me/lipastudios/2.00" target="_blank" onclick="trackDonationClick('2.00')">🍕 2€</a>
                <a href="https://paypal.me/lipastudios/5.00" target="_blank" onclick="trackDonationClick('5.00')">🎮 5€</a>
            </div>
        </div>
    </div>

    <script>
        console.log("🧪 NEON LAB PHYSICS WOW - ULTRA REALISTIC VERSION");
        
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        
        let gameState = {
            currentLevel: 1,
            objects: [],
            particle: null,
            launcher: null,
            chamber: null,
            draggedObject: null,
            dragOffset: { x: 0, y: 0 },
            lives: 3,
            maxLives: 3,
            score: 0,
            effects: [],
            particles: [],
            levelCompleted: false,
            gameOver: false
        };
        
        let isDragging = false;
        let lastTapTime = 0;
        let tapTarget = null;
        let lastTime = 0;
        let animationId = null;
        
        // Audio context for sounds
        let audioContext = null;
        let sounds = {};
        
        // Initialize audio
        function initAudio() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
        }
        
        // Create sound effects
        function createSound(frequency, duration, type = 'sine') {
            if (!audioContext) return;
            
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.frequency.setValueAtTime(frequency, audioContext.currentTime);
            oscillator.type = type;
            
            // Envelope
            gainNode.gain.setValueAtTime(0, audioContext.currentTime);
            gainNode.gain.linearRampToValueAtTime(0.3, audioContext.currentTime + 0.01);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration);
            
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + duration);
        }
        
        // Sound effects
        function playBounceSound() {
            const frequencies = [200, 300, 400, 500];
            const randomFreq = frequencies[Math.floor(Math.random() * frequencies.length)];
            createSound(randomFreq, 0.1, 'square');
        }
        
        function playLaunchSound() {
            createSound(600, 0.3, 'sine');
            setTimeout(() => createSound(800, 0.2, 'sine'), 100);
        }
        
        function playVictorySound() {
            // Victory melody
            const melody = [523, 659, 784, 1047]; // C, E, G, C
            melody.forEach((freq, index) => {
                setTimeout(() => createSound(freq, 0.3, 'sine'), index * 150);
            });
        }
        
        function playRotateSound() {
            createSound(400, 0.1, 'triangle');
        }
        
        // Initialize background particles
        function initBackgroundParticles() {
            const container = document.getElementById('particlesBg');
            for (let i = 0; i < 50; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle-bg';
                particle.style.left = Math.random() * 100 + '%';
                particle.style.animationDelay = Math.random() * 8 + 's';
                particle.style.animationDuration = (6 + Math.random() * 4) + 's';
                container.appendChild(particle);
            }
        }
        
        // Responsive canvas
        function resizeCanvas() {
            if (window.innerWidth < 768) {
                const maxWidth = Math.min(320, window.innerWidth - 20);
                const maxHeight = Math.min(450, window.innerHeight * 0.5);
                canvas.width = maxWidth;
                canvas.height = maxHeight;
            } else {
                canvas.width = 400;
                canvas.height = 600;
            }
        }
        
        class GameObject {
            constructor(type, x, y, width, height, color) {
                this.type = type;
                this.x = x;
                this.y = y;
                this.width = width;
                this.height = height;
                this.color = color;
                this.rotation = 0;
                this.draggable = type !== 'launcher' && type !== 'chamber';
                this.glowIntensity = 0;
                this.pulsePhase = 0;
                this.isLauncher = type === 'launcher';
                this.isTarget = type === 'chamber';
            }
            
            update(deltaTime) {
                this.pulsePhase += deltaTime * 3;
                this.glowIntensity = Math.sin(this.pulsePhase) * 0.3 + 0.7;
            }
            
            render(ctx) {
                ctx.save();
                ctx.translate(this.x + this.width/2, this.y + this.height/2);
                ctx.rotate(this.rotation);
                
                // Enhanced glow effect
                ctx.shadowColor = this.color;
                ctx.shadowBlur = 15 * this.glowIntensity;
                ctx.lineWidth = 3;
                ctx.strokeStyle = this.color;
                ctx.fillStyle = this.color;
                
                if (this.isLauncher) {
                    // LAUNCHER - Clear start indicator
                    ctx.fillStyle = '#FFFF00';
                    ctx.strokeStyle = '#FFFFFF';
                    ctx.lineWidth = 4;
                    ctx.shadowColor = '#FFFF00';
                    ctx.shadowBlur = 20;
                    
                    // Draw launcher as a circle with arrow
                    ctx.beginPath();
                    ctx.arc(0, 0, this.width/2, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.stroke();
                    
                    // Draw arrow pointing down
                    ctx.fillStyle = '#000000';
                    ctx.shadowBlur = 0;
                    ctx.beginPath();
                    ctx.moveTo(0, -this.width/4);
                    ctx.lineTo(-this.width/6, this.width/6);
                    ctx.lineTo(this.width/6, this.width/6);
                    ctx.closePath();
                    ctx.fill();
                    
                    // Draw "START" text
                    ctx.fillStyle = '#000000';
                    ctx.font = 'bold 8px Arial';
                    ctx.textAlign = 'center';
                    ctx.fillText('START', 0, -this.width/2 - 10);
                    
                } else if (this.isTarget) {
                    // TARGET - Clear end indicator
                    ctx.fillStyle = '#FF0080';
                    ctx.strokeStyle = '#FFFFFF';
                    ctx.lineWidth = 4;
                    ctx.shadowColor = '#FF0080';
                    ctx.shadowBlur = 20;
                    
                    // Draw target as a circle with bullseye
                    ctx.beginPath();
                    ctx.arc(0, 0, this.width/2, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.stroke();
                    
                    // Draw inner circle
                    ctx.fillStyle = '#FFFFFF';
                    ctx.shadowBlur = 0;
                    ctx.beginPath();
                    ctx.arc(0, 0, this.width/3, 0, Math.PI * 2);
                    ctx.fill();
                    
                    // Draw center dot
                    ctx.fillStyle = '#FF0080';
                    ctx.beginPath();
                    ctx.arc(0, 0, this.width/6, 0, Math.PI * 2);
                    ctx.fill();
                    
                    // Draw "GOAL" text
                    ctx.fillStyle = '#FFFFFF';
                    ctx.font = 'bold 8px Arial';
                    ctx.textAlign = 'center';
                    ctx.fillText('GOAL', 0, this.width/2 + 15);
                    
                } else if (this.type === 'ramp') {
                    // Enhanced triangle with gradient
                    const gradient = ctx.createLinearGradient(-this.width/2, -this.height/2, this.width/2, this.height/2);
                    gradient.addColorStop(0, this.color);
                    gradient.addColorStop(1, this.color + '80');
                    
                    ctx.fillStyle = gradient;
                    ctx.beginPath();
                    ctx.moveTo(-this.width/2, this.height/2);
                    ctx.lineTo(this.width/2, this.height/2);
                    ctx.lineTo(this.width/2, -this.height/2);
                    ctx.closePath();
                    ctx.fill();
                    ctx.stroke();
                } else if (this.type === 'bouncy-pad') {
                    // Enhanced circle with radial gradient
                    const gradient = ctx.createRadialGradient(0, 0, 0, 0, 0, this.width/2);
                    gradient.addColorStop(0, this.color);
                    gradient.addColorStop(1, this.color + '60');
                    
                    ctx.fillStyle = gradient;
                    ctx.beginPath();
                    ctx.arc(0, 0, this.width/2, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.stroke();
                } else {
                    // Enhanced rectangle with gradient
                    const gradient = ctx.createLinearGradient(-this.width/2, -this.height/2, this.width/2, this.height/2);
                    gradient.addColorStop(0, this.color);
                    gradient.addColorStop(1, this.color + '80');
                    
                    ctx.fillStyle = gradient;
                    ctx.fillRect(-this.width/2, -this.height/2, this.width, this.height);
                    ctx.strokeRect(-this.width/2, -this.height/2, this.width, this.height);
                }
                
                ctx.restore();
            }
            
            contains(x, y) {
                return x >= this.x && x <= this.x + this.width && 
                       y >= this.y && y <= this.y + this.height;
            }
        }
        
        class Particle {
            constructor(x, y) {
                this.x = x;
                this.y = y;
                this.vx = 0; // No initial horizontal velocity - pure gravity
                this.vy = 0; // No initial vertical velocity - pure gravity
                this.radius = 8;
                this.active = true;
                this.trail = [];
                this.bounces = 0;
                this.energy = 1.0;
                this.glowPhase = 0;
                this.sparkles = [];
                this.spin = 0;
                this.spinSpeed = 0;
                this.lastCollisionTime = 0;
            }
            
            update(deltaTime) {
                if (!this.active) return;
                
                this.glowPhase += deltaTime * 15;
                this.spin += this.spinSpeed * deltaTime;
                
                // Enhanced gravity with air resistance
                this.vy += 500 * deltaTime; // Stronger gravity
                this.vx *= 0.998; // Less air resistance for more bounce
                
                // Update position
                this.x += this.vx * deltaTime;
                this.y += this.vy * deltaTime;
                
                // Create sparkles based on speed
                const speed = Math.sqrt(this.vx * this.vx + this.vy * this.vy);
                if (Math.random() < 0.4 && speed > 50) {
                    this.sparkles.push({
                        x: this.x + (Math.random() - 0.5) * 30,
                        y: this.y + (Math.random() - 0.5) * 30,
                        life: 0.8,
                        maxLife: 0.8,
                        vx: (Math.random() - 0.5) * 100,
                        vy: (Math.random() - 0.5) * 100
                    });
                }
                
                // Update sparkles with physics
                this.sparkles = this.sparkles.filter(sparkle => {
                    sparkle.life -= deltaTime;
                    sparkle.x += sparkle.vx * deltaTime;
                    sparkle.y += sparkle.vy * deltaTime;
                    sparkle.vy += 200 * deltaTime; // Gravity for sparkles
                    return sparkle.life > 0;
                });
                
                // Check collisions
                for (let obj of gameState.objects) {
                    if (this.collidesWith(obj)) {
                        this.handleCollision(obj);
                        break;
                    }
                }
                
                // Boundary collisions with CRAZY effects
                if (this.x <= this.radius || this.x >= canvas.width - this.radius) {
                    this.vx = -this.vx * 0.9; // More bounce
                    this.x = Math.max(this.radius, Math.min(canvas.width - this.radius, this.x));
                    this.spinSpeed += Math.random() * 20 - 10; // Random spin
                    this.createImpactEffect(this.x, this.y);
                    playBounceSound(); // Play bounce sound
                    this.createScreenShake(0.2);
                }
                if (this.y <= this.radius) {
                    this.vy = Math.abs(this.vy) * 0.9; // More bounce
                    this.y = this.radius;
                    this.spinSpeed += Math.random() * 20 - 10; // Random spin
                    this.createImpactEffect(this.x, this.y);
                    playBounceSound(); // Play bounce sound
                    this.createScreenShake(0.2);
                }
                
                // Update trail with more particles
                this.trail.push({ 
                    x: this.x, 
                    y: this.y, 
                    life: 1.0,
                    size: this.radius * (0.5 + Math.random() * 0.5)
                });
                this.trail.forEach(point => point.life -= deltaTime * 1.5);
                this.trail = this.trail.filter(point => point.life > 0);
                
                // Deactivate if falls off screen
                if (this.y > canvas.height + 100) {
                    this.active = false;
                    loseLife();
                }
                
                // Energy loss over time (slower)
                this.energy -= deltaTime * 0.05;
                if (this.energy <= 0) {
                    this.active = false;
                }
            }
            
            createImpactEffect(x, y) {
                const effect = document.createElement('div');
                effect.className = 'impact-effect';
                effect.style.left = x + 'px';
                effect.style.top = y + 'px';
                document.body.appendChild(effect);
                setTimeout(() => effect.remove(), 300);
            }
            
            createScreenShake(intensity) {
                document.body.style.animation = `shake ${intensity}s ease-in-out`;
                setTimeout(() => document.body.style.animation = '', intensity * 1000);
            }
            
            collidesWith(obj) {
                if (obj.type === 'chamber') {
                    // Special circular collision for target
                    const centerX = obj.x + obj.width / 2;
                    const centerY = obj.y + obj.height / 2;
                    const dx = this.x - centerX;
                    const dy = this.y - centerY;
                    const distance = Math.sqrt(dx * dx + dy * dy);
                    return distance < (obj.width / 2); // Use radius instead of radius + particle radius
                }
                
                const closestX = Math.max(obj.x, Math.min(this.x, obj.x + obj.width));
                const closestY = Math.max(obj.y, Math.min(this.y, obj.y + obj.height));
                
                const dx = this.x - closestX;
                const dy = this.y - closestY;
                
                return (dx * dx + dy * dy) < (this.radius * this.radius);
            }
            
            handleCollision(obj) {
                // Special handling for target - capture the particle
                if (obj.type === 'chamber') {
                    this.active = false;
                    gameState.score += 100;
                    gameState.levelCompleted = true;
                    
                    // Play victory sound
                    playVictorySound();
                    
                    // Create celebration effect
                    for (let i = 0; i < 20; i++) {
                        this.sparkles.push({
                            x: this.x + (Math.random() - 0.5) * 60,
                            y: this.y + (Math.random() - 0.5) * 60,
                            life: 2.0,
                            maxLife: 2.0,
                            vx: (Math.random() - 0.5) * 300,
                            vy: (Math.random() - 0.5) * 300
                        });
                    }
                    
                    // Auto advance to next level after celebration
                    setTimeout(() => {
                        nextLevel();
                    }, 2000);
                    
                    return; // Don't bounce, just capture
                }
                
                const centerX = obj.x + obj.width / 2;
                const centerY = obj.y + obj.height / 2;
                
                let normalX = this.x - centerX;
                let normalY = this.y - centerY;
                const length = Math.sqrt(normalX * normalX + normalY * normalY);
                
                if (length > 0) {
                    normalX /= length;
                    normalY /= length;
                }
                
                // Push particle out
                this.x = centerX + normalX * (obj.width/2 + this.radius + 2);
                this.y = centerY + normalY * (obj.height/2 + this.radius + 2);
                
                // CRAZY bounce physics
                let elasticity = 0.8;
                if (obj.type === 'bouncy-pad') {
                    elasticity = 1.4; // Super bouncy!
                } else if (obj.type === 'ramp') {
                    elasticity = 1.1; // Slightly bouncy
                }
                
                const dot = this.vx * normalX + this.vy * normalY;
                const speed = Math.sqrt(this.vx * this.vx + this.vy * this.vy);
                
                // Apply bounce with random variation for chaos
                const randomFactor = 0.8 + Math.random() * 0.4; // 0.8 to 1.2
                this.vx -= 2 * dot * normalX * elasticity * this.energy * randomFactor;
                this.vy -= 2 * dot * normalY * elasticity * this.energy * randomFactor;
                
                // Add random spin based on collision
                this.spinSpeed += (Math.random() - 0.5) * 30;
                
                // Ramp behavior with enhanced physics
                if (obj.type === 'ramp') {
                    const angle = obj.rotation - Math.PI/4;
                    const newSpeed = Math.sqrt(this.vx * this.vx + this.vy * this.vy) * 1.1; // Speed boost
                    this.vx = Math.cos(angle) * newSpeed;
                    this.vy = Math.sin(angle) * newSpeed;
                }
                
                this.bounces++;
                this.lastCollisionTime = Date.now();
                
                // Create spectacular impact effects
                this.createImpactEffect(this.x, this.y);
                
                // Play bounce sound
                playBounceSound();
                
                // Screen shake based on impact force
                const impactForce = speed / 100;
                this.createScreenShake(Math.min(impactForce * 0.3, 0.5));
                
                // Create explosion of sparkles
                for (let i = 0; i < 8; i++) {
                    this.sparkles.push({
                        x: this.x + (Math.random() - 0.5) * 40,
                        y: this.y + (Math.random() - 0.5) * 40,
                        life: 1.0,
                        maxLife: 1.0,
                        vx: (Math.random() - 0.5) * 200,
                        vy: (Math.random() - 0.5) * 200
                    });
                }
            }
            
            render(ctx) {
                if (!this.active) return;
                
                // Enhanced trail with fading and size variation
                this.trail.forEach((point, index) => {
                    const alpha = point.life * (index + 1) / this.trail.length;
                    ctx.save();
                    ctx.globalAlpha = alpha * 0.9;
                    ctx.fillStyle = '#FFFF00';
                    ctx.shadowColor = '#FFFF00';
                    ctx.shadowBlur = 15;
                    ctx.beginPath();
                    ctx.arc(point.x, point.y, point.size * alpha, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.restore();
                });
                
                // Main particle with CRAZY effects
                ctx.save();
                ctx.translate(this.x, this.y);
                ctx.rotate(this.spin);
                
                // Outer glow
                ctx.shadowColor = '#FFFF00';
                ctx.shadowBlur = 30 * this.energy;
                ctx.fillStyle = '#FFFF00';
                ctx.beginPath();
                ctx.arc(0, 0, this.radius * this.energy, 0, Math.PI * 2);
                ctx.fill();
                
                // Middle ring
                ctx.shadowBlur = 15;
                ctx.fillStyle = '#FFAA00';
                ctx.beginPath();
                ctx.arc(0, 0, this.radius * 0.8 * this.energy, 0, Math.PI * 2);
                ctx.fill();
                
                // Inner core
                ctx.shadowBlur = 0;
                ctx.fillStyle = '#FFFFFF';
                ctx.beginPath();
                ctx.arc(0, 0, this.radius * 0.4 * this.energy, 0, Math.PI * 2);
                ctx.fill();
                
                // Speed lines
                const speed = Math.sqrt(this.vx * this.vx + this.vy * this.vy);
                if (speed > 100) {
                    ctx.strokeStyle = '#FFFFFF';
                    ctx.lineWidth = 2;
                    ctx.globalAlpha = 0.6;
                    for (let i = 0; i < 3; i++) {
                        ctx.beginPath();
                        ctx.moveTo(-this.radius * 1.5, 0);
                        ctx.lineTo(-this.radius * 2.5, (Math.random() - 0.5) * 10);
                        ctx.stroke();
                    }
                }
                
                ctx.restore();
                
                // Render sparkles with physics
                this.sparkles.forEach(sparkle => {
                    ctx.save();
                    ctx.globalAlpha = sparkle.life / sparkle.maxLife;
                    const colors = ['#00FFFF', '#FF00FF', '#FFFF00', '#FF0080'];
                    ctx.fillStyle = colors[Math.floor(Math.random() * colors.length)];
                    ctx.shadowColor = ctx.fillStyle;
                    ctx.shadowBlur = 8;
                    ctx.beginPath();
                    ctx.arc(sparkle.x, sparkle.y, 3, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.restore();
                });
            }
        }
        
        // Enhanced level definitions - FÍSICA REALISTA CON OBJETIVOS LATERALES
        const levels = [
            {
                name: "Tutorial - Caída Libre",
                objects: [
                    { type: 'ramp', x: 120, y: 160, width: 80, height: 60, color: '#FF0080' },
                    { type: 'bouncy-pad', x: 200, y: 280, width: 50, height: 50, color: '#39FF14' }
                ],
                target: { x: 80, y: 350, radius: 30 }, // IZQUIERDA
                launcher: { x: 160, y: 25 }
            },
            {
                name: "Rebote Perfecto",
                objects: [
                    { type: 'block', x: 80, y: 120, width: 60, height: 15, color: '#00FFFF' },
                    { type: 'bouncy-pad', x: 160, y: 200, width: 60, height: 60, color: '#39FF14' },
                    { type: 'ramp', x: 40, y: 280, width: 90, height: 70, color: '#FF0080' }
                ],
                target: { x: 240, y: 350, radius: 30 }, // DERECHA
                launcher: { x: 160, y: 25 }
            },
            {
                name: "Maze de Gravedad",
                objects: [
                    { type: 'block', x: 40, y: 80, width: 80, height: 15, color: '#00FFFF' },
                    { type: 'block', x: 160, y: 140, width: 80, height: 15, color: '#00FFFF' },
                    { type: 'bouncy-pad', x: 80, y: 200, width: 50, height: 50, color: '#39FF14' },
                    { type: 'ramp', x: 200, y: 250, width: 80, height: 60, color: '#FF0080' },
                    { type: 'block', x: 40, y: 320, width: 60, height: 15, color: '#00FFFF' }
                ],
                target: { x: 280, y: 350, radius: 30 }, // EXTREMA DERECHA
                launcher: { x: 160, y: 25 }
            },
            {
                name: "Desafío Vertical",
                objects: [
                    { type: 'bouncy-pad', x: 80, y: 100, width: 50, height: 50, color: '#39FF14' },
                    { type: 'block', x: 160, y: 160, width: 60, height: 15, color: '#00FFFF' },
                    { type: 'bouncy-pad', x: 240, y: 220, width: 50, height: 50, color: '#39FF14' },
                    { type: 'ramp', x: 120, y: 280, width: 80, height: 60, color: '#FF0080' }
                ],
                target: { x: 60, y: 350, radius: 30 }, // EXTREMA IZQUIERDA
                launcher: { x: 160, y: 25 }
            },
            {
                name: "Máximo Reto",
                objects: [
                    { type: 'block', x: 40, y: 80, width: 50, height: 15, color: '#00FFFF' },
                    { type: 'bouncy-pad', x: 120, y: 110, width: 40, height: 40, color: '#39FF14' },
                    { type: 'block', x: 200, y: 140, width: 50, height: 15, color: '#00FFFF' },
                    { type: 'ramp', x: 80, y: 190, width: 60, height: 45, color: '#FF0080' },
                    { type: 'bouncy-pad', x: 160, y: 250, width: 40, height: 40, color: '#39FF14' },
                    { type: 'block', x: 240, y: 300, width: 50, height: 15, color: '#00FFFF' }
                ],
                target: { x: 260, y: 350, radius: 30 }, // DERECHA
                launcher: { x: 160, y: 25 }
            }
        ];
        
        function initLevel(levelIndex) {
            gameState.currentLevel = levelIndex + 1;
            gameState.objects = [];
            gameState.particle = null;
            gameState.effects = [];
            gameState.particles = [];
            gameState.levelCompleted = false;
            gameState.gameOver = false;
            
            const level = levels[levelIndex];
            level.objects.forEach(objData => {
                const obj = new GameObject(
                    objData.type,
                    objData.x, 
                    objData.y, 
                    objData.width, 
                    objData.height, 
                    objData.color
                );
                gameState.objects.push(obj);
            });
            
            // Create launcher at top of screen
            gameState.launcher = new GameObject('launcher', level.launcher.x - 15, level.launcher.y - 15, 30, 30, '#FFFF00');
            gameState.objects.push(gameState.launcher);
            
            // Create target chamber at bottom
            gameState.chamber = new GameObject('chamber', level.target.x - level.target.radius, level.target.y - level.target.radius, level.target.radius * 2, level.target.radius * 2, '#FF0080');
            gameState.objects.push(gameState.chamber);
            
            updateUI();
        }
        
        function updateUI() {
            document.getElementById('levelDisplay').textContent = `LEVEL ${gameState.currentLevel}`;
            document.getElementById('livesDisplay').textContent = '❤️'.repeat(gameState.lives);
        }
        
        function launchParticle() {
            if (gameState.particle && gameState.particle.active) return;
            
            // Initialize audio on first user interaction
            initAudio();
            
            // Create particle at launcher position (top of screen)
            gameState.particle = new Particle(gameState.launcher.x + 15, gameState.launcher.y + 15);
            
            // Play launch sound
            playLaunchSound();
            
            // Add launch effect
            const effect = document.createElement('div');
            effect.className = 'flash-effect';
            document.body.appendChild(effect);
            setTimeout(() => effect.remove(), 500);
        }
        
        function resetLevel() {
            initLevel(gameState.currentLevel - 1);
        }
        
        function nextLevel() {
            if (!gameState.levelCompleted && !gameState.gameOver) {
                return; // Don't allow next level if current level not completed
            }
            
            if (gameState.currentLevel < levels.length) {
                initLevel(gameState.currentLevel);
            } else {
                // All levels completed
                const overlay = document.createElement('div');
                overlay.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0, 0, 0, 0.9);
                    display: flex;
                    flex-direction: column;
                    justify-content: center;
                    align-items: center;
                    z-index: 10000;
                    color: #00FFFF;
                    font-family: 'Orbitron', monospace;
                `;
                
                overlay.innerHTML = `
                    <div style="text-align: center; padding: 2rem;">
                        <h1 style="font-size: 3rem; margin-bottom: 1rem; color: #39FF14; text-shadow: 0 0 20px #39FF14;">🎉 ¡FELICIDADES!</h1>
                        <p style="font-size: 1.5rem; margin-bottom: 2rem;">Has completado todos los niveles</p>
                        <p style="font-size: 1.2rem; margin-bottom: 2rem;">Puntuación Final: ${gameState.score}</p>
                        
                        <!-- Donation Section -->
                        <div style="margin: 2rem 0; padding: 1.5rem; background: rgba(57, 255, 20, 0.1); border: 2px solid #39FF14; border-radius: 15px;">
                            <h3 style="color: #FFFF00; margin-bottom: 1rem; font-size: 1.3rem;">💖 ¡Apoya el desarrollo!</h3>
                            <p style="margin-bottom: 1.5rem; color: #FFFFFF; font-size: 1rem;">¡Eres un maestro de la física! Ayúdanos a crear más juegos</p>
                            <div style="display: flex; gap: 0.8rem; justify-content: center; flex-wrap: wrap; margin-bottom: 1rem;">
                                <a href="https://paypal.me/lipastudios/0.50" target="_blank" onclick="trackDonationClick('0.50')" style="
                                    padding: 12px 20px; 
                                    background: linear-gradient(45deg, #4CAF50, #8BC34A); 
                                    color: white; 
                                    font-weight: bold; 
                                    border-radius: 8px; 
                                    text-decoration: none; 
                                    font-size: 14px;
                                    transition: transform 0.3s ease;
                                    display: inline-block;
                                " onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                                    ☕ 0,50€
                                </a>
                                <a href="https://paypal.me/lipastudios/2.00" target="_blank" onclick="trackDonationClick('2.00')" style="
                                    padding: 12px 20px; 
                                    background: linear-gradient(45deg, #FF9800, #FFC107); 
                                    color: white; 
                                    font-weight: bold; 
                                    border-radius: 8px; 
                                    text-decoration: none; 
                                    font-size: 14px;
                                    transition: transform 0.3s ease;
                                    display: inline-block;
                                " onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                                    🍕 2€
                                </a>
                                <a href="https://paypal.me/lipastudios/5.00" target="_blank" onclick="trackDonationClick('5.00')" style="
                                    padding: 12px 20px; 
                                    background: linear-gradient(45deg, #E91E63, #F06292); 
                                    color: white; 
                                    font-weight: bold; 
                                    border-radius: 8px; 
                                    text-decoration: none; 
                                    font-size: 14px;
                                    transition: transform 0.3s ease;
                                    display: inline-block;
                                " onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                                    🎮 5€
                                </a>
                            </div>
                        </div>
                        
                        <div style="display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap;">
                            <button onclick="showLeaderboard('neon-lab-physics-wow')" style="
                                background: linear-gradient(45deg, #FFD700, #FFA500);
                                border: 2px solid #FFFFFF;
                                color: #000;
                                padding: 15px 30px;
                                border-radius: 8px;
                                font-weight: bold;
                                font-family: 'Orbitron', monospace;
                                font-size: 1.1rem;
                                cursor: pointer;
                                transition: transform 0.3s ease;
                            " onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                                🏆 RANKING
                            </button>
                            <button onclick="restartGame()" style="
                                background: linear-gradient(45deg, #FF0080, #00FFFF);
                                border: 2px solid #FFFFFF;
                                color: #000;
                                padding: 15px 30px;
                                border-radius: 8px;
                                font-weight: bold;
                                font-family: 'Orbitron', monospace;
                                font-size: 1.1rem;
                                cursor: pointer;
                                transition: transform 0.3s ease;
                            " onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                                🔄 JUGAR DE NUEVO
                            </button>
                            <button onclick="closeGameOver()" style="
                                background: linear-gradient(45deg, #39FF14, #FFFF00);
                                border: 2px solid #FFFFFF;
                                color: #000;
                                padding: 15px 30px;
                                border-radius: 8px;
                                font-weight: bold;
                                font-family: 'Orbitron', monospace;
                                font-size: 1.1rem;
                                cursor: pointer;
                                transition: transform 0.3s ease;
                            " onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                                ❌ CERRAR
                            </button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(overlay);
            }
        }
        
        function loseLife() {
            gameState.lives--;
            updateUI();
            
            if (gameState.lives <= 0) {
                gameState.gameOver = true;
                    showGameOver();
            }
        }
        
        function showGameOver() {
            // Submit score to leaderboard
            if (leaderboard) {
                leaderboard.submitScore(gameState.score, gameState.currentLevel, 1);
            }
            
            // Create game over overlay
            const overlay = document.createElement('div');
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.9);
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
                z-index: 10000;
                color: #00FFFF;
                font-family: 'Orbitron', monospace;
            `;
            
            overlay.innerHTML = `
                <div style="text-align: center; padding: 2rem;">
                    <h1 style="font-size: 3rem; margin-bottom: 1rem; color: #FF0080; text-shadow: 0 0 20px #FF0080;">💀 GAME OVER</h1>
                    <p style="font-size: 1.5rem; margin-bottom: 2rem;">Puntuación Final: ${gameState.score}</p>
                    <p style="font-size: 1.2rem; margin-bottom: 2rem;">Nivel Alcanzado: ${gameState.currentLevel}</p>
                    
                    <!-- Donation Section -->
                    <div style="margin: 2rem 0; padding: 1.5rem; background: rgba(255, 0, 128, 0.1); border: 2px solid #FF0080; border-radius: 15px;">
                        <h3 style="color: #FFFF00; margin-bottom: 1rem; font-size: 1.3rem;">💖 ¡Apoya el desarrollo!</h3>
                        <p style="margin-bottom: 1.5rem; color: #FFFFFF; font-size: 1rem;">Cada donación nos motiva a crear más juegos épicos</p>
                        <div style="display: flex; gap: 0.8rem; justify-content: center; flex-wrap: wrap; margin-bottom: 1rem;">
                            <a href="https://paypal.me/lipastudios/0.50" target="_blank" onclick="trackDonationClick('0.50')" style="
                                padding: 12px 20px; 
                                background: linear-gradient(45deg, #4CAF50, #8BC34A); 
                                color: white; 
                                font-weight: bold; 
                                border-radius: 8px; 
                                text-decoration: none; 
                                font-size: 14px;
                                transition: transform 0.3s ease;
                                display: inline-block;
                            " onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                                ☕ 0,50€
                            </a>
                            <a href="https://paypal.me/lipastudios/2.00" target="_blank" onclick="trackDonationClick('2.00')" style="
                                padding: 12px 20px; 
                                background: linear-gradient(45deg, #FF9800, #FFC107); 
                                color: white; 
                                font-weight: bold; 
                                border-radius: 8px; 
                                text-decoration: none; 
                                font-size: 14px;
                                transition: transform 0.3s ease;
                                display: inline-block;
                            " onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                                🍕 2€
                            </a>
                            <a href="https://paypal.me/lipastudios/5.00" target="_blank" onclick="trackDonationClick('5.00')" style="
                                padding: 12px 20px; 
                                background: linear-gradient(45deg, #E91E63, #F06292); 
                                color: white; 
                                font-weight: bold; 
                                border-radius: 8px; 
                                text-decoration: none; 
                                font-size: 14px;
                                transition: transform 0.3s ease;
                                display: inline-block;
                            " onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                                🎮 5€
                            </a>
                </div>
                </div>
                
                    <div style="display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap;">
                        <button onclick="restartGame()" style="
                            background: linear-gradient(45deg, #FF0080, #00FFFF);
                            border: 2px solid #FFFFFF;
                            color: #000;
                            padding: 15px 30px;
                            border-radius: 8px;
                            font-weight: bold;
                            font-family: 'Orbitron', monospace;
                            font-size: 1.1rem;
                            cursor: pointer;
                            transition: transform 0.3s ease;
                        " onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                            🔄 JUGAR DE NUEVO
                        </button>
                        <button onclick="closeGameOver()" style="
                            background: linear-gradient(45deg, #39FF14, #FFFF00);
                            border: 2px solid #FFFFFF;
                            color: #000;
                            padding: 15px 30px;
                            border-radius: 8px;
                            font-weight: bold;
                            font-family: 'Orbitron', monospace;
                            font-size: 1.1rem;
                            cursor: pointer;
                            transition: transform 0.3s ease;
                        " onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                            ❌ CERRAR
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(overlay);
        }
        
        function restartGame() {
            // Remove game over overlay
            const overlay = document.querySelector('div[style*="position: fixed"]');
            if (overlay) overlay.remove();
            
            // Reset game state
            gameState.lives = gameState.maxLives;
            gameState.score = 0;
            gameState.gameOver = false;
            gameState.levelCompleted = false;
            
            // Start from level 1
            initLevel(0);
            updateUI();
        }
        
        function closeGameOver() {
            // Remove game over overlay
            const overlay = document.querySelector('div[style*="position: fixed"]');
            if (overlay) overlay.remove();
        }
        
        function showHelp() {
            alert(`🧪 NEON LAB PHYSICS WOW - AYUDA

🎯 OBJETIVO: Coloca objetos para que la partícula caiga por gravedad y llegue al objetivo rojo

🎮 CONTROLES:
• Arrastra objetos para posicionarlos
• Doble tap para rotar objetos
• Presiona DROP para soltar la partícula

🔧 OBJETOS:
• 🟡 LAUNCHER: Punto de salida (parte superior)
• 🔴 TARGET: Objetivo a alcanzar (parte inferior)
• 🔺 RAMP: Rampa que desvía la partícula
• 🟢 BOUNCY PAD: Superficie elástica que rebota
• 🔵 BLOCK: Bloque sólido que desvía

💡 CONSEJO: La partícula cae por gravedad, usa los objetos para crear el camino perfecto!`);
        }
        
        function gameLoop(currentTime) {
            const deltaTime = (currentTime - lastTime) / 1000;
            lastTime = currentTime;
            
            // Clear canvas with enhanced background
            ctx.fillStyle = 'rgba(0, 0, 0, 0.1)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            
            // Update and render objects
            gameState.objects.forEach(obj => {
                obj.update(deltaTime);
                obj.render(ctx);
            });
            
            // Update and render particle
            if (gameState.particle) {
                gameState.particle.update(deltaTime);
                gameState.particle.render(ctx);
                
            }
            
            animationId = requestAnimationFrame(gameLoop);
        }
        
        // Event listeners
        canvas.addEventListener('mousedown', (e) => {
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            for (let obj of gameState.objects) {
                if (obj.draggable && obj.contains(x, y)) {
                    gameState.draggedObject = obj;
                    gameState.dragOffset = { x: x - obj.x, y: y - obj.y };
                    isDragging = true;
                    break;
                }
            }
        });
        
        canvas.addEventListener('mousemove', (e) => {
            if (!isDragging || !gameState.draggedObject) return;
            
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            gameState.draggedObject.x = x - gameState.dragOffset.x;
            gameState.draggedObject.y = y - gameState.dragOffset.y;
        });
        
        canvas.addEventListener('mouseup', () => {
            isDragging = false;
            gameState.draggedObject = null;
        });
        
        // Touch events
        canvas.addEventListener('touchstart', (e) => {
            e.preventDefault();
            const rect = canvas.getBoundingClientRect();
            const touch = e.touches[0];
            const x = touch.clientX - rect.left;
            const y = touch.clientY - rect.top;
            
            const currentTime = Date.now();
            if (currentTime - lastTapTime < 300) {
            // Double tap - rotate object
            for (let obj of gameState.objects) {
                if (obj.draggable && obj.contains(x, y)) {
                    obj.rotation += Math.PI / 4;
                    // Play rotate sound
                    playRotateSound();
                    // Add visual feedback
                    const effect = document.createElement('div');
                    effect.className = 'impact-effect';
                    effect.style.left = x + 'px';
                    effect.style.top = y + 'px';
                    effect.style.background = 'radial-gradient(circle, #00FFFF, transparent)';
                    document.body.appendChild(effect);
                    setTimeout(() => effect.remove(), 300);
                    break;
                }
            }
            }
            lastTapTime = currentTime;
            
            for (let obj of gameState.objects) {
                if (obj.draggable && obj.contains(x, y)) {
                    gameState.draggedObject = obj;
                    gameState.dragOffset = { x: x - obj.x, y: y - obj.y };
                    isDragging = true;
                    break;
                }
            }
        });
        
        canvas.addEventListener('touchmove', (e) => {
            e.preventDefault();
            if (!isDragging || !gameState.draggedObject) return;
            
            const rect = canvas.getBoundingClientRect();
            const touch = e.touches[0];
            const x = touch.clientX - rect.left;
            const y = touch.clientY - rect.top;
            
            gameState.draggedObject.x = x - gameState.dragOffset.x;
            gameState.draggedObject.y = y - gameState.dragOffset.y;
        });
        
        canvas.addEventListener('touchend', (e) => {
            e.preventDefault();
            isDragging = false;
            gameState.draggedObject = null;
        });
        
        // ===== LEADERBOARD FUNCTIONS =====
        let leaderboard;
        
        function showLeaderboard(gameId) {
            if (window.showLeaderboard && typeof window.showLeaderboard === 'function') {
                window.showLeaderboard(gameId || 'neon-lab-physics-wow');
            }
        }
        
        function hideLeaderboard() {
            const modal = document.querySelector('[style*="position: fixed"]');
            if (modal) modal.remove();
        }

        // Initialize game
        window.addEventListener('load', () => {
                resizeCanvas();
            initBackgroundParticles();
            initLevel(0);
            lastTime = performance.now();
            gameLoop(lastTime);
            
            // Initialize leaderboard
            setTimeout(() => {
                leaderboard = new GlobalLeaderboard('neon-lab-physics-wow');
            }, 100);
        });
        
        window.addEventListener('resize', resizeCanvas);
        
        // Add shake animation
        const style = document.createElement('style');
        style.textContent = `
            @keyframes shake {
                0%, 100% { transform: translateX(0); }
                25% { transform: translateX(-2px); }
                75% { transform: translateX(2px); }
            }
        `;
        document.head.appendChild(style);
    </script>
    
    <!-- MONETAG MULTI TAG -->
    <script src="https://fpyf8.com/88/tag.min.js" data-zone="176552" async data-cfasync="false"></script>
</body>
</html>
